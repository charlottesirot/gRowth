---
title: "Untitled"
author: "Charlotte S"
date: "21 f√©vrier 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


### 1. Import of the raw data of signature

```{r include=FALSE, cache=FALSE} 
tkmessageBox(message = "Choose a CNEA file", type = "ok")
CN_EA.path <- tclvalue(tkgetOpenFile())
if (!nchar(CN_EA.path)) {
 tkmessageBox(message = "No file was selected!")
} else {
 tkmessageBox(message = paste("The file selected was", CN_EA.path))
}
# CN_EA.path <- "/home/cha/Dropbox/Post-doc_Danemark/Results/Script/CNEA.xls"
CN_EA.data <- read.xls(xls = CN_EA.path, sheet = 1, header = TRUE)

Rank.Analysis <- 2: (nrow(CN_EA.data)+ 1) # +1 to make the excel file correspond to the R file

CN_EA.data <- cbind(Rank.Analysis, CN_EA.data)

nrow.CN_EA <- nrow(CN_EA.data)
ncol.CN_EA <- ncol(CN_EA.data)
```
The CN_EA file chosen is `r CN_EA.path`
<br><br>

### 2. Conditions tested by CNEA.CleanR




### 3. Any identifier 1 should not be empty or null

```{r} 
level.identifier.1 <- levels(CN_EA.data$Identifier.1)

bad.Id1 <- which(CN_EA.data$Identifier.1 == "" | is.na(CN_EA.data$Identifier.1) | is.null(CN_EA.data$Identifier.1))

if(length(bad.Id1) != 0) {
  CN_EA.data <- CN_EA.data[-bad.Id1, ]
  
  toDisplay.1 <- paste("Some identifier.1 are empty. Please remove the line:", paste(bad.Id1, sep = " ", collapse = ""))
  
} else {
   toDisplay.1 <- "No problem in the identifier.1"
}
```
<br>
**CONCLUSIONS:** `r toDisplay.1`
<br><br>

### 4. Value requirement validation 
Here, CN_EA.CleanR controles for errors and abnormalities that **have to be controled and corrected** by the user. 
```{r} 
CN_EA.data.liste <- split(CN_EA.data, CN_EA.data$Identifier.1)

CN_EA.data.liste <- CN_EA.data.liste[which(names(CN_EA.data.liste) != "")]

resultMatrix <- matrix(NA,ncol = 4) #the matrix summurizing the number of values for d13C and d15N
signature.Table <- matrix(NA,ncol = 6) # the final matrix with the signature

error.dilution <- vector()

for(i in 1:length(CN_EA.data.liste)) {
  
  dataProv <- CN_EA.data.liste[[i]]
  
  One.Analysis <- separateAnalysis_CNEA(dataProv, column1 = dataProv$d.13C.12C, column2 = dataProv$d.15N.14N)
  
  number.Analysis <- length(One.Analysis)
  
  for(j in 1:number.Analysis) {
    
    ### deal with dilution 
    
    dilution <- One.Analysis[[j]]$Sample.Dilution
    
    not0 <- which(dilution != 0)
    
    length.not0 <- length(which(duplicated(dilution[not0]) == FALSE))
    
    if(length.not0 != 1){
      
      error.dilution <- c(error.dilution, One.Analysis[[j]]$Rank.Analysis[1])
      
    } else {}
    
    d13C <- which(!is.na(One.Analysis[[j]]$d.13C.12C) & !is.null(One.Analysis[[j]]$d.13C.12C) & One.Analysis[[j]]$d.13C.12C != "")
    d15N <- which(!is.na(One.Analysis[[j]]$d.15N.14N) & !is.null(One.Analysis[[j]]$d.15N.14N) & One.Analysis[[j]]$d.15N.14N != "")
    
    toAdd <- c(names(CN_EA.data.liste)[i], One.Analysis[[j]]$Rank.Analysis[1], length(d13C), length(d15N))
    
    resultMatrix <- rbind(resultMatrix, toAdd)
    
    toAdd.signture <- c(names(CN_EA.data.liste)[i], One.Analysis[[j]]$Rank.Analysis[1], as.character(One.Analysis[[j]]$Identifier.2[1]), One.Analysis[[j]]$d.15N.14N[d15N[length(d15N)]], dilution[not0[1]], One.Analysis[[j]]$d.13C.12C[d13C[1]])
    
    signature.Table <- rbind(signature.Table, toAdd.signture)
  }
}

resultMatrix <- resultMatrix[-1,]

signature.Table <- signature.Table[-1,]

colnames(resultMatrix) <- c("identifier.1", "FirstLine", "Nb.d13C", "Nb.d15N")
resultMatrix <- as.data.frame(resultMatrix)

colnames(signature.Table) <- c("identifier.1", "FirstLine", "identifier.2","d13C", "dilution", "d15N")
rownames(signature.Table) <- seq(1:nrow(signature.Table))
signature.Table <- as.data.frame(signature.Table)


## detect the error

error.d13C <- resultMatrix$FirstLine[which(as.numeric(as.character(resultMatrix$Nb.d13C)) == 0 | resultMatrix$Nb.d13C == "")]
error.d15N <- resultMatrix$FirstLine[which(as.numeric(as.character(resultMatrix$Nb.d15N)) == 0 | resultMatrix$Nb.d15N == "")]

is.error.d13C <- length(error.d13C)
is.error.d15N <- length(error.d15N)



```

**CONCLUSIONS FOR D13C:** <br>
`r if(is.error.d13C != 0) {paste("Some lines of the CN_EA file are missing values. Please check line(s)", paste(error.d13C, sep = " ", collapse = " "))} else {"Your file is OK"} `
<br><br>
**CONCLUSIONS FOR D15N:** <br>
`r if(is.error.d15N != 0) {paste("Some lines of the CN_EA file are missing values. Please check line(s)", paste(error.d15N, sep = " ", collapse = " "))} else {"Your file is OK"} `
<br><br>

### 5. Mistakes that only require a warning
Here, CN_EA.CleanR shows some abnormalities that have to be controled by the user. Those abnormalities do not require a correction, but a simple checking.

```{r}
## detect weirdlines (i.e. different that 2 analysis for d13C and different than 3 or 4 for d15N)

length.error.dilution <- length(error.dilution)

weird.d13C <- resultMatrix$FirstLine[which(as.numeric(as.character(resultMatrix$Nb.d13C)) != 2)]
weird.d15N <- resultMatrix$FirstLine[which(as.numeric(as.character(resultMatrix$Nb.d15N)) != 4 & as.numeric(as.character(resultMatrix$Nb.d15N)) != 3)]

is.weird.d13C <- length(weird.d13C)
is.weird.d15N <- length(weird.d15N)

```

**CONCLUSIONS FOR DILUTION:** <br>
`r if(length.error.dilution != 0) {paste("Some dilutions are not the same for a same analysis. Please check the analyis line(s)", paste(error.dilution, sep = " ", collapse = " "))} else {"Your file is OK"} `
<br><br>
**CONCLUSIONS FOR D13C:** <br>
`r if(is.weird.d13C != 0) {paste("Some lines of the CN_EA file have too much or too few values. Please check line(s)", paste(weird.d13C, sep = " ", collapse = " "))} else {"Your file is OK"} `
<br><br>
**CONCLUSIONS FOR D15N:** <br>
`r if(is.weird.d15N != 0) {paste("Some lines of the CN_EA file have too much or too few values. Please check line(s)", paste(weird.d15N, sep = " ", collapse = " "))} else {"Your file is OK"} `
<br><br>

### 6. Visual checking
This part displays the d13C signatures and d15N signatures (CNEA.CleanR automatically takes the last value for the d15N and the first value for the d13C)) to detect potential errors in the CN_EA file. Check it out ;)

```{r}

level.identifier.1 <- levels(CN_EA.data$Identifier.1)

radioButtons("toDisplay", label = "",
    choices = level.identifier.1,
    selected = level.identifier.1[1])

output$boxplot <- renderPlot({

  if(!is.null(input$toDisplay)) {
    
    dataToPlot <- split(signature.Table, signature.Table$identifier.1)
    
    dataTemp <- dataToPlot[which(names(dataToPlot) == input$toDisplay)]
    
    par(mfrow = c(1,2), mar = c(2,3,1.2,1.2))
    
    ylim.d13C  <- c(min(as.numeric(as.character(dataTemp[[1]]$d13C)), na.rm = T) - abs(min(as.numeric(as.character(dataTemp[[1]]$d13C)), na.rm = T))*0.1, max(as.numeric(as.character(dataTemp[[1]]$d13C)), na.rm = T) + abs(max(as.numeric(as.character(dataTemp[[1]]$d13C)), na.rm = T))*0.1)
    
    boxplot.with.outlier.label(as.numeric(as.character(dataTemp[[1]]$d13C)), label_name = dataTemp[[1]]$identifier.2, ylim = ylim.d13C, cex = 1.25)
    
    mtext("d13C", side = 1)
    
    ylim.d15N  <- c(min(as.numeric(as.character(dataTemp[[1]]$d15N)), na.rm = T) - abs(min(as.numeric(as.character(dataTemp[[1]]$d15N)), na.rm = T))*0.1, max(as.numeric(as.character(dataTemp[[1]]$d15N)), na.rm = T) + abs(max(as.numeric(as.character(dataTemp[[1]]$d15N)), na.rm = T))*0.1)

    
    boxplot.with.outlier.label(as.numeric(as.character(dataTemp[[1]]$d15N)), label_name = dataTemp[[1]]$identifier.2, ylim = ylim.d15N)
    
    mtext("d15N", side = 1)
  } else {}
  
})
```
`r plotOutput('boxplot')`
<br><br>

### **Conclusions **
Please, correct the potential mistakes highlighted by CN_EA.CleanR and upload your CN_EA file to finally check that there is longer any problem before using isoSign.creatR
<br><br>


